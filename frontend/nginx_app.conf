# Configuration Nginx pour EcoRide sur Heroku
daemon off;
worker_processes auto;

events {
  use epoll;
  worker_connections 1024;
}

http {
  include mime.types;
  default_type application/octet-stream;
  server_tokens off;

  client_max_body_size 10M;
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;
  gzip on;
  gzip_comp_level 6;
  gzip_min_length 1000;
  gzip_types text/plain text/css application/json application/javascript application/xml;

  server {
    listen $PORT;
    port_in_redirect off;
    
    root /app;
    index frontend/pages/public/index.html;
    
    # Forcer HTTPS
    if ($http_x_forwarded_proto != "https") {
      return 301 https://$host$request_uri;
    }
    
    # En-têtes de sécurité pour éviter les redirections non désirées
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Redirection de / vers /pages/public/index.html
    location = / {
      return 301 /frontend/pages/public/index.html;
    }
    
    # Servir les fichiers statiques
    location /frontend/assets/ {
      access_log off;
      expires 30d;
      add_header Cache-Control "public, max-age=2592000";
    }
    
    # Gestion des pages HTML - PAS de fallback vers index.html
    location /frontend/pages/ {
      try_files $uri $uri.html $uri/ =404;
    }
    
    # Gestion des erreurs
    error_page 404 /frontend/pages/public/error.html;
  }
} 